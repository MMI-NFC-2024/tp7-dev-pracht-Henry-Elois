---
import "leaflet/dist/leaflet.css";
import Layout from "../layouts/Layout.astro";
import populationMain from "../assets/populationMain.json";

const listePeriode = [
  ...new Set(populationMain?.map((d) => d.Période)),
].reverse();
const listeSex = [...new Set(populationMain?.map((d) => d.Sexe))];
const listeAge = [...new Set(populationMain?.map((d) => d.Âge))];
---

<Layout title="Population" currentPage="population">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Visualisation de la population</h1>

    <div class="flex gap-4 mb-6">
      <div>
        <label for="periode" class="block mb-2 font-medium">Année</label>
        <select id="periode" class="border rounded p-2">
          {
            listePeriode.map((p, i) => (
              <option value={p} selected={i === 0}>
                {p}
              </option>
            ))
          }
        </select>
      </div>

      <div>
        <label for="sex" class="block mb-2 font-medium text-black">Sexe</label>
        <select id="sex" class="border rounded p-2">
          {
            listeSex.map((s, i) => (
              <option value={s} selected={i === 0}>
                {s}
              </option>
            ))
          }
        </select>
      </div>

      <div>
        <label for="age" class="block mb-2 font-medium">Âge</label>
        <select id="age" class="border rounded p-2">
          {
            listeAge.map((a, i) => (
              <option value={a} selected={i === 0}>
                {a}
              </option>
            ))
          }
        </select>
      </div>
    </div>
    <div id="map" class="border rounded-lg" style="height: 600px;"></div>

    <div id="results" class="mt-4 p-4 bg-gray-50 rounded">
      Sélectionnez les filtres pour voir les données.
    </div>
  </div>
</Layout>

<script>
  import L from "leaflet";
  import populationMain from "../assets/populationMain.json";

  const elmYear = document.getElementById("periode") as HTMLSelectElement;
  const elmSex = document.getElementById("sex") as HTMLSelectElement;
  const elmAge = document.getElementById("age") as HTMLSelectElement;
  const results = document.getElementById("results");

  let selectedYear = Number(elmYear.value);
  let selectedSex = elmSex.value;
  let selectedAge = elmAge.value;

  const map = L.map("map").setView([46.6033, 1.883], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  let markers = [];

  function updateMap() {

    markers.forEach((marker) => map.removeLayer(marker));
    markers = [];
    const filteredData = populationMain.filter(
      (d) =>
        d.Période === selectedYear &&
        d.Sexe === selectedSex &&
        d.Âge === selectedAge
    );

    filteredData.forEach((data, index) => {
      const lat = 46.6033 + (Math.random() - 0.5) * 10;
      const lon = 1.883 + (Math.random() - 0.5) * 10;

      const marker = L.circleMarker([lat, lon], {
        radius: Math.sqrt(data.Valeur / 1000) + 3,
        fillColor: "#3B82F6",
        color: "#1E40AF",
        weight: 2,
        opacity: 0.8,
        fillOpacity: 0.6,
      }).addTo(map);

      marker.bindPopup(`
        <b>${data.Géographie}</b><br>
        Population: ${data.Valeur.toLocaleString()}<br>
        Année: ${selectedYear}<br>
        Sexe: ${selectedSex}<br>
        Âge: ${selectedAge}
      `);

      markers.push(marker);
    });

    if (results) {
      results.innerHTML = `
        <h3 class="font-bold mb-2">Données sélectionnées</h3>
        <p>Année: ${selectedYear} | Sexe: ${selectedSex} | Âge: ${selectedAge}</p>
        <p>Données trouvées: ${filteredData.length} enregistrement(s)</p>
      `;
    }
  }
  elmYear.addEventListener("change", (e) => {
    selectedYear = Number(e.target.value);
    updateMap();
  });

  elmSex.addEventListener("change", (e) => {
    selectedSex = e.target.value;
    updateMap();
  });

  elmAge.addEventListener("change", (e) => {
    selectedAge = e.target.value;
    updateMap();
  });

  updateMap();
</script>
