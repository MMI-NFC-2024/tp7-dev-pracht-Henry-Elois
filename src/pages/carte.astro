---
import "leaflet/dist/leaflet.css";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <main class="max-w-5xl mx-auto p-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">
        Carte des établissements d'enseignement supérieur
      </h1>
      <p class="text-gray-600 leading-relaxed">
        Cette carte interactive présente la localisation des établissements
        d'enseignement supérieur en France. Elle est accompagnée d'une
        description et d'une liste textuelle des établissements pour garantir
        une accessibilité complète.
      </p>
    </header>

    <!-- SECTION ACCESSIBLE AVEC FIGURE -->
    <figure
      class="border-2 border-gray-300 rounded-lg mb-8 focus:outline-none focus:ring-4 focus:ring-blue-400"
      aria-label="Visualisation géographique des établissements d’enseignement supérieur"
    >
      <!-- TITRES ET LÉGENDES -->
      <figcaption class="p-4 bg-gray-50 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-700 mb-1">
          Répartition géographique des établissements
        </h2>
        <p class="text-gray-500 text-sm">
          Figure 1. Carte interactive affichant les établissements
          d’enseignement supérieur en France. Vous pouvez naviguer avec la
          souris ou le clavier et cliquer sur les marqueurs pour plus
          d’informations.
        </p>
      </figcaption>

      <!-- CARTE -->
      <div
        id="map"
        class="w-full h-[600px] rounded-b-lg"
        role="img"
        aria-label="Carte interactive des établissements d’enseignement supérieur en France"
        tabindex="0"
      >
      </div>
    </figure>

    <!-- INFORMATIONS SUR LA CARTE -->
    <section aria-labelledby="infos-titre" class="mb-8">
      <h2 id="infos-titre" class="text-xl font-semibold text-gray-700 mb-3">
        Informations sur la carte
      </h2>
      <div
        id="map-info"
        class="bg-gray-50 border border-gray-200 rounded-md p-4 italic"
        aria-live="polite"
        aria-atomic="true"
      >
        <p>
          Carte centrée sur la France. Utilisez les flèches du clavier pour
          naviguer sur la carte.
        </p>
      </div>
    </section>

    <!-- RECHERCHE ET LISTE -->
    <section aria-labelledby="liste-titre">
      <h2 id="liste-titre" class="text-xl font-semibold text-gray-700 mb-3">
        Liste des établissements
      </h2>

      <!-- Barre de recherche -->
      <div class="mb-4">
        <label
          for="recherche-etablissement"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Rechercher un établissement
        </label>
        <div class="relative">
          <input
            type="text"
            id="recherche-etablissement"
            class="w-full px-4 py-2 pl-10 pr-4 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Tapez le nom d'un établissement ou d'une ville..."
            aria-describedby="recherche-aide"
          />
          <div class="absolute inset-y-0 left-0 flex items-center pl-3">
            <svg
              class="w-5 h-5 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>
        <p id="recherche-aide" class="mt-1 text-sm text-gray-500">
          Recherchez par nom d'établissement ou ville.
          <span id="resultats-count" class="font-medium"></span>
        </p>
      </div>

      <!-- Liste -->
      <div
        id="etablissements-liste"
        class="border border-gray-300 rounded-md p-4 max-h-96 overflow-y-auto"
        role="region"
        aria-label="Liste textuelle des établissements affichés sur la carte"
        aria-live="polite"
      >
      </div>
    </section>
  </main>
</Layout>

<!-- Script Leaflet -->
<script>
  import L from "leaflet";
  import listeEtablissements from "../assets/listeEtablissements.json";

  const map = L.map("map", { keyboard: true, keyboardPanDelta: 80 }).setView(
    [46.6033, 1.883],
    6
  );

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:
      "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors",
  }).addTo(map);

  // Exemple d'accessibilité sur les marqueurs
  listeEtablissements.forEach((etab) => {
    const marker = L.marker([etab.lat, etab.lon], {
      title: etab.name,
      alt: `Établissement ${etab.name}`,
    }).addTo(map);
    marker.bindPopup(`
      <div role="dialog" aria-label="Informations sur l'établissement">
        <h3 class="text-blue-700 font-semibold">${etab.name}</h3>
        <p><strong>Coordonnées :</strong> ${etab.lat.toFixed(4)}, ${etab.lon.toFixed(4)}</p>
      </div>
    `);
  });
</script>
